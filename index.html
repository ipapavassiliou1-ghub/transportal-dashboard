<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>transportal â€“ API Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow:0 10px 30px rgba(0,0,0,0.06);
    --primary:#6d28d9;
    --primary2:#4f46e5;
    --blue:#2563eb;
    --green:#16a34a;
    --amber:#f59e0b;
    --red:#ef4444;
  }
  *{ box-sizing:border-box; }
  body{
    font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    background: var(--bg);
    margin:0;
    padding: 28px;
    color: var(--text);
  }

  /* Header */
  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 12px;
    margin-bottom: 18px;
  }
  h1{ margin:0 0 6px; font-size:34px; letter-spacing:-0.02em; }
  .subtitle{ margin:0; color:var(--muted); font-size:15px; }
  .pill{
    background: rgba(109,40,217,.1);
    color: var(--primary);
    padding: 8px 12px;
    border-radius: 999px;
    font-weight: 900;
    font-size: 12px;
    display:flex;
    align-items:center;
    gap: 8px;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;background:var(--green);
    box-shadow:0 0 0 4px rgba(22,163,74,.15);
  }
  .dot.idle{ background:#9ca3af; box-shadow:none; }
  .dot.warn{ background:var(--amber); box-shadow:0 0 0 4px rgba(245,158,11,.15); }

  /* Sections */
  .section{ margin: 26px 0; }
  .sectionTitle{ margin: 0 0 12px; font-size: 20px; letter-spacing:-0.01em; }

  /* Controls */
  .controlsRow{
    display:flex;
    gap: 10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .control{
    background: var(--card);
    border: 1px solid var(--border);
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    display:flex;
    gap: 10px;
    align-items:center;
  }
  .control label{
    color: var(--muted);
    font-size: 13px;
    font-weight: 800;
  }
  select, input[type="text"], input[type="file"]{
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background:#fff;
    font-size: 14px;
    outline:none;
  }
  input[type="text"]{ min-width: 240px; }

  /* Buttons */
  button{
    padding: 10px 14px;
    border:none;
    border-radius: 12px;
    font-weight: 900;
    cursor:pointer;
    transition: transform .08s ease, opacity .2s ease;
    user-select:none;
  }
  button:active{ transform: translateY(1px); }
  button[disabled]{ opacity:.55; cursor:not-allowed; }
  .btnPrimary{
    background: linear-gradient(135deg,var(--primary),var(--primary2));
    color: #fff;
    box-shadow: 0 12px 26px rgba(109,40,217,.22);
  }
  .btnGhost{
    background:#fff;
    border:1px solid var(--border);
    color: var(--text);
    box-shadow: var(--shadow);
  }
  .btnBlue{
    background: linear-gradient(135deg,#2563eb,#1d4ed8);
    color:#fff;
    box-shadow: 0 12px 26px rgba(37,99,235,.18);
  }

  /* Inline toast */
  .toastInline{
    display:none;
    padding: 8px 10px;
    border-radius: 12px;
    font-weight: 900;
    font-size: 13px;
    border: 1px solid rgba(109,40,217,.18);
    background: rgba(109,40,217,.08);
    color:#4c1d95;
  }
  .toastInline.show{ display:inline-flex; }

  /* KPI cards */
  .cardGrid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
    gap: 14px;
  }
  .card{
    background: var(--card);
    border: 1px solid rgba(229,231,235,.9);
    border-radius: 16px;
    padding: 18px;
    box-shadow: var(--shadow);
    position:relative;
    overflow:hidden;
  }
  .card h3{ margin:0 0 6px; font-size:13px; color:var(--muted); font-weight:900; }
  .value{ font-size: 30px; font-weight: 950; letter-spacing:-0.02em; }
  .sub{ margin-top: 6px; font-size:12px; color:var(--muted); font-weight:800; }

  /* Carrier cards */
  .carrierGrid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
    gap: 12px;
  }
  .carrierCard{
    background:#fff;
    border:1px solid var(--border);
    border-radius: 16px;
    padding: 14px;
    box-shadow: var(--shadow);
  }
  .carrierTop{ display:flex; justify-content:space-between; align-items:center; gap: 10px; }
  .carrierName{ font-weight:950; font-size: 14px; }
  .carrierCount{ font-weight:950; color: var(--primary); }
  .miniBar{ height:8px; background:#eef2ff; border-radius:999px; overflow:hidden; margin-top:10px; }
  .miniFill{ height:100%; width:0%; background: linear-gradient(90deg,var(--primary),var(--primary2)); border-radius:999px; transition: width .6s ease; }
  .carrierMeta{ margin-top:8px; display:flex; justify-content:space-between; color: var(--muted); font-weight:900; font-size: 12px; }

  /* Table */
  .tableWrap{
    background:#fff;
    border:1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  table{ width:100%; border-collapse:collapse; }
  th, td{
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    text-align:left;
    font-size: 14px;
    vertical-align: middle;
  }
  th{ background:#f9fafb; font-weight:950; }
  tr:hover td{ background: rgba(109,40,217,.04); }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size: 12px; }

  /* Badges */
  .badge{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 950;
    white-space:nowrap;
  }
  .badgeDot{ width:8px; height:8px; border-radius:999px; background: currentColor; opacity:.75; }
  .completed{ background:#dcfce7; color:#166534; }
  .processing{ background:#fef3c7; color:#92400e; }
  .error{ background:#fee2e2; color:#991b1b; }
  .not_found{ background:#e5e7eb; color:#374151; }

  /* Progress */
  .progressRow{ display:flex; align-items:center; gap: 10px; }
  .progressBar{
    height: 8px; width: 140px;
    background:#e5e7eb;
    border-radius:999px;
    overflow:hidden;
    position:relative;
  }
  .progressFill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg,var(--primary),var(--primary2));
    border-radius:999px;
    transition: width .65s cubic-bezier(.2,.9,.2,1);
  }
  .progressPulse{
    position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
    transform: translateX(-100%);
    animation: shimmer 1.2s infinite;
    opacity:0;
  }
  .isProcessing .progressPulse{ opacity: 1; }
  @keyframes shimmer{
    0%{ transform: translateX(-100%); }
    100%{ transform: translateX(100%); }
  }
  .progressText{ font-size: 12px; font-weight: 950; width: 54px; text-align:right; }

  /* Toolbar */
  .tableToolbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding: 12px;
    border-bottom:1px solid var(--border);
    background:#fff;
    flex-wrap:wrap;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 8px 10px;
    border-radius:999px;
    background:#f3f4f6;
    border:1px solid var(--border);
    font-size: 12px;
    font-weight: 950;
  }
  .pager{ display:flex; align-items:center; gap: 8px; }
  .mutedSmall{ color: var(--muted); font-size: 12px; font-weight: 900; }

  /* Modal */
  .modalOverlay{
    position:fixed;
    inset:0;
    background: rgba(17,24,39,.55);
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index: 9999;
  }
  .modal{
    width: min(980px, 100%);
    max-height: 86vh;
    overflow:hidden;
    background:#fff;
    border-radius: 18px;
    box-shadow: 0 24px 80px rgba(0,0,0,.25);
    border: 1px solid rgba(255,255,255,.35);
  }
  .modalHeader{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 10px;
    padding: 16px 16px 12px;
    border-bottom:1px solid var(--border);
    background: linear-gradient(180deg, rgba(109,40,217,.06), transparent 65%);
  }
  .modalTitle{ margin:0; font-size: 16px; font-weight: 950; }
  .modalSub{ margin:6px 0 0; color: var(--muted); font-size: 12px; font-weight: 900; }
  .modalBody{
    padding: 14px 16px 16px;
    overflow:auto;
    max-height: calc(86vh - 64px);
  }
  .xBtn{
    background:#fff;
    border:1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 950;
    box-shadow: var(--shadow);
  }
  .modalGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }
  .infoCard{
    background:#fff;
    border:1px solid var(--border);
    border-radius: 14px;
    padding: 12px;
    box-shadow: var(--shadow);
  }
  .infoKey{ color:var(--muted); font-size:12px; font-weight:950; }
  .infoVal{ margin-top:4px; font-weight:950; }

  .footer{
    margin-top: 44px;
    text-align:center;
    color: var(--muted);
    font-size: 14px;
  }
  .brand{ font-weight: 950; color: var(--primary); font-size: 20px; }

  .linkLike{ color: var(--primary); text-decoration: underline; cursor:pointer; font-weight: 950; }
</style>
</head>

<body>

<div class="topbar">
  <div>
    <h1>ðŸ“Š Operations Control Tower</h1>
    <p class="subtitle">Live operational visibility across carriers and batches</p>
  </div>
  <div class="pill">
    <span id="liveDot" class="dot idle"></span>
    <span id="liveText">Idle</span>
  </div>
</div>

<!-- Controls -->
<div class="section">
  <div class="controlsRow">

    <!-- Client -->
    <div class="control">
      <label>Client</label>
      <select id="apiKeySelect">
        <option value="demo-key-123">demo-key-123</option>
        <option value="demo-key-456">demo-key-456</option>
      </select>
    </div>

    <!-- Time Scope (created_at based) -->
    <div class="control">
      <label>Time Scope</label>
      <select id="timeScope">
        <option value="7" selected>Last 7 days</option>
        <option value="14">Last 14 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="all">All time</option>
      </select>
    </div>

    <!-- Status -->
    <div class="control">
      <label>Status</label>
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="processing">processing</option>
        <option value="completed">completed</option>
        <option value="error">error</option>
      </select>
    </div>

    <!-- Search -->
    <div class="control">
      <label>Search</label>
      <input id="searchInput" type="text" placeholder="Batch IDâ€¦ (paste request_id)" />
    </div>

    <!-- Rows -->
    <div class="control">
      <label>Rows</label>
      <select id="pageSize">
        <option value="10">10</option>
        <option value="25" selected>25</option>
        <option value="50">50</option>
      </select>
    </div>

    <!-- Refresh -->
    <button class="btnGhost" id="refreshBtn">Refresh</button>

  </div>
</div>

<!-- Upload -->
<div class="section">
  <h2 class="sectionTitle">Upload New Batch</h2>
  <div class="controlsRow">
    <div class="control">
      <label>File</label>
      <input type="file" id="fileInput" />
    </div>

    <div class="control">
      <label>Export</label>
      <select id="exportFormat">
        <option value="xlsx" selected>xlsx</option>
        <option value="csv">csv</option>
        <option value="json">json</option>
      </select>
    </div>

    <button class="btnPrimary" id="uploadBtn">Upload</button>
    <span class="toastInline" id="uploadStatus"></span>
  </div>
  <div class="mutedSmall" style="margin-top:10px;">
    Upload a CSV/XLSX with tracking numbers (optional: reference, carrier).
  </div>
</div>

<!-- Analytics -->
<div class="section">
  <h2 class="sectionTitle">Analytics</h2>
  <div class="cardGrid">
    <div class="card">
      <h3>Total Batches</h3>
      <div class="value" id="totalBatches">â€“</div>
      <div class="sub">Last 50 from API</div>
    </div>
    <div class="card">
      <h3>Total Shipments</h3>
      <div class="value" id="totalShipments">â€“</div>
      <div class="sub">Across current dataset</div>
    </div>
    <div class="card">
      <h3>Delivered</h3>
      <div class="value" id="deliveredCount">â€“</div>
      <div class="sub">Delivered shipments</div>
    </div>
    <div class="card">
      <h3>Pending</h3>
      <div class="value" id="pendingCount">â€“</div>
      <div class="sub">Pending/in transit</div>
    </div>
    <div class="card">
      <h3>Errors</h3>
      <div class="value" id="errorCount">â€“</div>
      <div class="sub">Failed lookups</div>
    </div>
    <div class="card">
      <h3>Success Rate</h3>
      <div class="value" id="successRate">â€“</div>
      <div class="sub">Delivered / Total</div>
    </div>
  </div>
</div>

<!-- Carrier split -->
<div class="section">
  <h2 class="sectionTitle">Carrier KPI split (from recent completed batches)</h2>
  <div id="carrierKpis" class="carrierGrid"></div>
  <div class="mutedSmall" style="margin-top:10px;">
    Tip: Click a batch ID to open details (shipment-level drill-down).
  </div>
</div>

<!-- Batches -->
<div class="section">
  <h2 class="sectionTitle">Recent Batches</h2>

  <div class="tableWrap">
    <div class="tableToolbar">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="chip" id="datasetChip">0 batches</span>
        <span class="chip" id="processingChip">0 processing</span>
      </div>
      <div class="pager">
        <button class="btnGhost" id="prevBtn">Prev</button>
        <span class="chip" id="pageChip">Page 1</span>
        <button class="btnGhost" id="nextBtn">Next</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Batch ID</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Shipments</th>
          <th>Created</th>
          <th>Completed</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="batchTable">
        <tr><td colspan="7">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="footer">
  powered by <span class="brand">transportal</span>
</div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const BASE_POST = "https://api.transportal.gr/webhook/api/v1";
const BASE_GET  = "https://api.transportal.gr/webhook/51df26b4-d41e-4654-a11b-e668573d6ca5/api/v1";

/* =========================================================
   STATE
========================================================= */
let allBatches = [];
let filtered = [];
let scopedBatches = []; // created_at filtered dataset
let page = 1;
let pageSize = 25;

let pollTimer = null;
let activeLoadToken = 0;

/* =========================================================
   HELPERS
========================================================= */
function safeJsonParse(x){
  if (x && typeof x === "object") return x;
  if (typeof x !== "string") return {};
  try { return JSON.parse(x); } catch { return {}; }
}

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

function getApiKey(){ return document.getElementById("apiKeySelect").value; }
function getStatusFilter(){ return document.getElementById("statusFilter").value; }
function getSearchText(){ return (document.getElementById("searchInput").value||"").toLowerCase().trim(); }

function showToast(msg){
  const el = document.getElementById("uploadStatus");
  el.textContent = msg;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=>el.classList.remove("show"),3500);
}

/* =========================================================
   LIVE INDICATOR
========================================================= */
function setLive(state){
  const dot = document.getElementById("liveDot");
  const text = document.getElementById("liveText");
  dot.classList.remove("idle","warn");

  if(state==="polling"){
    dot.classList.add("warn");
    text.textContent="Polling";
  }else{
    dot.classList.add("idle");
    text.textContent="Idle";
  }
}

/* =========================================================
   UPLOAD
========================================================= */
async function uploadBatch(){
  const file = document.getElementById("fileInput").files[0];
  const exportFormat = document.getElementById("exportFormat").value;
  const apiKey = getApiKey();

  if(!file){ showToast("Select file first"); return; }

  const btn = document.getElementById("uploadBtn");
  btn.disabled = true;
  showToast("Uploading...");

  const formData = new FormData();
  formData.append("file", file);

  if(exportFormat==="json"){
    formData.append("response_mode","json");
    formData.append("export_format","csv");
  }else{
    formData.append("response_mode","file");
    formData.append("export_format",exportFormat);
  }

  try{
    const res = await fetch(`${BASE_POST}/track-batch`,{
      method:"POST",
      headers:{ "x-api-key": apiKey },
      body:formData
    });

    if(!res.ok) throw new Error("Upload failed");

    const data = await res.json();
    showToast("Batch accepted: "+data.request_id);
    document.getElementById("fileInput").value="";

    await loadDashboard(true);

  }catch(e){
    console.error(e);
    showToast("Upload failed");
  }

  btn.disabled=false;
}

/* =========================================================
   FETCH BATCH LIST
========================================================= */
async function fetchBatches(token){
  const res = await fetch(`${BASE_POST}/batches?ts=${Date.now()}`,{
    headers:{ "x-api-key": getApiKey() },
    cache:"no-store"
  });

  if(token!==activeLoadToken) return null;

  if(!res.ok){
    const text = await res.text().catch(()=> "");
    throw new Error("Load failed: " + text);
  }

  const text = await res.text();

  if(!text || !text.trim()){
    return []; // empty response = no batches
  }

  try{
    const json = JSON.parse(text);
    return Array.isArray(json) ? json : [];
  }catch(e){
    console.error("Invalid JSON from /batches:", text);
    return [];
  }
}

/* =========================================================
   FETCH DETAILS
========================================================= */
async function fetchDetails(batchId, token){
  const res = await fetch(`${BASE_GET}/track-batch/${batchId}?ts=${Date.now()}`,{
    headers:{ "x-api-key": getApiKey() },
    cache:"no-store"
  });

  if(token!==activeLoadToken) return null;
  if(!res.ok) throw new Error("Details failed");

  const ctype = (res.headers.get("content-type")||"").toLowerCase();

  if(ctype.includes("application/json")){
    return await res.json();
  }

  return { note:"File-based batch. Use Download." };
}

/* =========================================================
   FILTER + PAGINATION
========================================================= */
function applyFilters(){
  const status = getStatusFilter();
  const q = getSearchText();
  pageSize = Number(document.getElementById("pageSize").value);

  filtered = allBatches.slice();

  if(status!=="all"){
    filtered = filtered.filter(b=> (b.status||"").toLowerCase()===status);
  }

  if(q){
    filtered = filtered.filter(b=> String(b.request_id).toLowerCase().includes(q));
  }

  const maxPage = Math.max(1, Math.ceil(filtered.length/pageSize));
  if(page>maxPage) page=maxPage;

  document.getElementById("datasetChip").textContent = filtered.length+" batches";
  document.getElementById("pageChip").textContent = "Page "+page+" / "+maxPage;
}

/* =========================================================
   PROGRESS
========================================================= */
function computeProgress(b){
  const s = safeJsonParse(b.summary);
  const total = Number(s.total||0);
  const delivered = Number(s.delivered||0);
  const error = Number(s.error||0);

  if(!total) return 0;
  if(b.status==="completed" || b.status==="error") return 100;

  return Math.min(100, Math.round(((delivered+error)/total)*100));
}

/* =========================================================
   RENDER TABLE
========================================================= */
function renderTable(){
  const tbody = document.getElementById("batchTable");
  tbody.innerHTML="";

  const start=(page-1)*pageSize;
  const slice=filtered.slice(start,start+pageSize);

  if(!slice.length){
    tbody.innerHTML="<tr><td colspan='7'>No batches</td></tr>";
    return;
  }

  slice.forEach(b=>{
    const percent = computeProgress(b);
    const s = safeJsonParse(b.summary);

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="mono linkLike" onclick="viewBatch('${b.request_id}')">${escapeHtml(b.request_id)}</td>
      <td><span class="badge ${["completed","processing","error"].includes(b.status) ? b.status : "not_found"}">${escapeHtml(b.status||"unknown")}</span></td>
      <td>
        <div class="progressRow ${b.status==='processing'?'isProcessing':''}">
          <div class="progressBar">
            <div class="progressFill" style="width:${percent}%"></div>
            <div class="progressPulse"></div>
          </div>
          <div class="progressText">${percent}%</div>
        </div>
      </td>
      <td>${s.total||0}</td>
      <td>${escapeHtml(b.created_at||"-")}</td>
      <td>${escapeHtml(b.completed_at||"-")}</td>
      <td>
        ${b.status==="completed"
          ?`<button class="btnBlue" onclick="downloadBatch('${b.request_id}')">Download</button>`
          :""}
        <button class="btnGhost" onclick="viewBatch('${b.request_id}')">View</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================================================
   KPI
========================================================= */
function renderKpis(){
  let total=0,del=0,pen=0,err=0;

  filtered.forEach(b=>{
    const s=safeJsonParse(b.summary);
    total+=Number(s.total||0);
    del+=Number(s.delivered||0);
    pen+=Number(s.pending||0);
    err+=Number(s.error||0);
  });

  document.getElementById("totalBatches").textContent=filtered.length;
  document.getElementById("totalShipments").textContent=total;
  document.getElementById("deliveredCount").textContent=del;
  document.getElementById("pendingCount").textContent=pen;
  document.getElementById("errorCount").textContent=err;

  const success = total?Math.round((del/total)*100):0;
  document.getElementById("successRate").textContent=success+"%";
}

/* =========================================================
   CARRIER SPLIT
========================================================= */
let carrierCacheKey = null;

async function renderCarrierSplit(token){
  const container = document.getElementById("carrierKpis");

  // Build a simple cache key from completed batch IDs
  const completed = allBatches
    .filter(b => b.status === "completed")
    .map(b => b.request_id)
    .join("|");

  // If nothing changed â†’ skip re-render
  if (carrierCacheKey === completed) return;

  carrierCacheKey = completed;

  container.style.opacity = "0.6"; // subtle loading state

  const agg = {};

  for (const b of allBatches.filter(b => b.status === "completed").slice(0,2)) {
    const d = await fetchDetails(b.request_id, token);
    if (!d || !d.results) continue;

    d.results.forEach(r=>{
      const c = r.carrier || "UNKNOWN";
      if(!agg[c]) agg[c] = { total:0, del:0 };
      agg[c].total++;
      if((r.status||"").toLowerCase()==="delivered") agg[c].del++;
    });
  }

  container.innerHTML = "";

  Object.entries(agg).forEach(([name,val])=>{
    const pct = val.total ? Math.round((val.del/val.total)*100) : 0;
    const div = document.createElement("div");
    div.className = "carrierCard";
    div.innerHTML = `
      <div class="carrierTop">
        <div class="carrierName">${escapeHtml(name)}</div>
        <div class="carrierCount">${val.total}</div>
      </div>
      <div class="miniBar">
        <div class="miniFill" style="width:${pct}%"></div>
      </div>
      <div class="carrierMeta">
        <span>${val.del} delivered</span>
        <span>${pct}%</span>
      </div>
    `;
    container.appendChild(div);
  });

  container.style.opacity = "1";
}

/* =========================================================
   VIEW MODAL
========================================================= */
async function viewBatch(batchId){
  const token=++activeLoadToken;
  const data=await fetchDetails(batchId,token);
  if(!data) return;

  if(data.note){
    openModal(batchId, `<p>${data.note}</p>`);
    return;
  }

  const rows=(data.results||[]).map(r=>`
    <tr>
      <td>${escapeHtml(r.tracking)}</td>
      <td>${escapeHtml(r.reference||"-")}</td>
      <td>${escapeHtml(r.carrier)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.error||"")}</td>
    </tr>
  `).join("");

  openModal(batchId,`
    <table>
      <thead>
        <tr><th>Tracking</th><th>Reference</th><th>Carrier</th><th>Status</th><th>Error</th></tr>
      </thead>
      <tbody>${rows||"<tr><td colspan='5'>No data</td></tr>"}</tbody>
    </table>
  `);
}

function openModal(title,html){
  closeModal();
  const overlay=document.createElement("div");
  overlay.className="modalOverlay";
  overlay.innerHTML=`
    <div class="modal">
      <div style="display:flex;justify-content:space-between;">
        <h3>${escapeHtml(title)}</h3>
        <button onclick="closeModal()">âœ•</button>
      </div>
      ${html}
    </div>
  `;
  overlay.onclick=e=>{ if(e.target===overlay) closeModal(); };
  document.body.appendChild(overlay);
}

function closeModal(){
  const el=document.querySelector(".modalOverlay");
  if(el) el.remove();
}

/* =========================================================
   DOWNLOAD
========================================================= */
async function downloadBatch(batchId){
  const res=await fetch(`${BASE_GET}/track-batch/${batchId}?ts=${Date.now()}`,{
    headers:{ "x-api-key": getApiKey() }
  });

  if(!res.ok){ showToast("Download failed"); return; }

  const blob=await res.blob();
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=batchId+".xlsx";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================================================
   MAIN LOAD
========================================================= */
async function loadDashboard(force){
  const token=++activeLoadToken;

  if(force) setLive("polling");

  try{
    allBatches=await fetchBatches(token);
    if(!allBatches) return;

    applyFilters();
    renderKpis();
    renderTable();
    renderCarrierSplit(token);

    const hasProcessing=filtered.some(b=>b.status==="processing");

    if(hasProcessing){
      if(!pollTimer){
        setLive("polling");
        pollTimer=setInterval(()=>loadDashboard(false),4000);
      }
    }else{
      clearInterval(pollTimer);
      pollTimer=null;
      setLive("idle");
    }

  }catch(e){
    console.error(e);
  }
}

/* =========================================================
   EVENTS
========================================================= */
document.getElementById("uploadBtn").addEventListener("click",uploadBatch);
document.getElementById("refreshBtn").addEventListener("click",()=>loadDashboard(true));
document.getElementById("apiKeySelect").addEventListener("change",()=>{
  clearInterval(pollTimer);
  pollTimer=null;
  page=1;
  allBatches=[];
  filtered=[];
  loadDashboard(true);
});
document.getElementById("statusFilter").addEventListener("change",()=>{page=1;applyFilters();renderKpis();renderTable();});
document.getElementById("searchInput").addEventListener("input",()=>{page=1;applyFilters();renderKpis();renderTable();});
document.getElementById("pageSize").addEventListener("change",()=>{page=1;applyFilters();renderKpis();renderTable();});
document.getElementById("prevBtn").addEventListener("click",()=>{page=Math.max(1,page-1);renderTable();});
document.getElementById("nextBtn").addEventListener("click",()=>{
  const max=Math.ceil(filtered.length/pageSize);
  page=Math.min(max,page+1);
  renderTable();
});

/* INITIAL LOAD */
loadDashboard(true);
</script>

</body>
</html>
