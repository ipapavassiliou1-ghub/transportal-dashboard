<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>transportal ‚Äì API Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,0.06);
  --primary:#6d28d9;
  --primary2:#4f46e5;
  --green:#16a34a;
  --amber:#f59e0b;
  --red:#ef4444;
}

*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  margin:0;
  padding:28px;
  color:var(--text);
}

/* Header */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:18px;
}
h1{margin:0 0 6px;font-size:34px}
.subtitle{margin:0;color:var(--muted)}
.pill{
  background:rgba(109,40,217,.1);
  color:var(--primary);
  padding:8px 12px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
}

/* Controls */
.section{margin:28px 0}
.controlsRow{display:flex;gap:10px;flex-wrap:wrap}
.control{
  background:var(--card);
  border:1px solid var(--border);
  padding:10px 12px;
  border-radius:12px;
  box-shadow:var(--shadow);
}
select,input{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--border);
}
button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}
.btnGhost{background:white;border:1px solid var(--border)}

/* Cards */
.cardGrid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:14px;
}
.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  box-shadow:var(--shadow);
}
.card h3{
  margin:0 0 6px;
  font-size:13px;
  color:var(--muted);
}
.value{font-size:28px;font-weight:900}

/* Carrier */
.carrierGrid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}
.carrierCard{
  background:white;
  border-radius:14px;
  padding:14px;
  box-shadow:var(--shadow);
}
.miniBar{
  height:6px;
  background:#eef2ff;
  border-radius:999px;
  overflow:hidden;
  margin-top:6px;
}
.miniFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--primary),var(--primary2));
  transition:width .5s ease;
}

/* Table */
.tableWrap{
  background:white;
  border-radius:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
table{width:100%;border-collapse:collapse}
th,td{padding:12px 14px;border-bottom:1px solid var(--border)}
th{background:#f9fafb;font-weight:800}
tr:hover td{background:rgba(109,40,217,.05)}
.badge{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
}
.completed{background:#dcfce7;color:#166534}
.processing{background:#fef3c7;color:#92400e}
.error{background:#fee2e2;color:#991b1b}

/* Progress */
.progressBar{
  height:6px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
  width:120px;
}
.progressFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--primary),var(--primary2));
  transition:width .6s ease;
}

/* Modal */
.modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal{
  background:white;
  width:90%;
  max-width:900px;
  border-radius:16px;
  padding:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  max-height:85vh;
  overflow:auto;
}

.footer{
  margin-top:40px;
  text-align:center;
  color:var(--muted);
}
.brand{
  font-weight:900;
  color:var(--primary);
  font-size:20px;
}
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>üì¶ transportal API Dashboard</h1>
    <p class="subtitle">Batch tracking analytics & monitoring</p>
  </div>
  <div class="pill">‚óè Live</div>
</div>

<div class="section">
  <div class="controlsRow">
    <div class="control">
      <label>Client</label>
      <select id="apiKeySelect">
        <option value="demo-key-123">demo-key-123</option>
        <option value="demo-key-456">demo-key-456</option>
      </select>
    </div>
    <button class="btnGhost" onclick="loadDashboard()">Refresh</button>
  </div>
</div>

<div class="section">
  <div class="cardGrid">
    <div class="card"><h3>Total Batches</h3><div class="value" id="totalBatches">‚Äì</div></div>
    <div class="card"><h3>Total Shipments</h3><div class="value" id="totalShipments">‚Äì</div></div>
    <div class="card"><h3>Delivered</h3><div class="value" id="deliveredCount">‚Äì</div></div>
    <div class="card"><h3>Pending</h3><div class="value" id="pendingCount">‚Äì</div></div>
    <div class="card"><h3>Errors</h3><div class="value" id="errorCount">‚Äì</div></div>
    <div class="card"><h3>Success Rate</h3><div class="value" id="successRate">‚Äì</div></div>
  </div>
</div>

<div class="section">
  <h2>Carrier Split</h2>
  <div id="carrierKpis" class="carrierGrid"></div>
</div>

<div class="section">
  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Batch ID</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Created</th>
          <th>Download</th>
        </tr>
      </thead>
      <tbody id="batchTable"></tbody>
    </table>
  </div>
</div>

<div class="footer">
  powered by <span class="brand">transportal</span>
</div>

<script>
const BASE_POST="https://api.transportal.gr/webhook/api/v1";
const BASE_GET="https://api.transportal.gr/webhook/51df26b4-d41e-4654-a11b-e668573d6ca5/api/v1";

let currentData=[];

async function loadDashboard(){
  const apiKey=document.getElementById("apiKeySelect").value;

  try{
    const res=await fetch(`${BASE_POST}/batches?ts=${Date.now()}`,{
      headers:{'x-api-key':apiKey}
    });

    const data=await res.json();
    if(!Array.isArray(data)) return;

    currentData=data;
    render(data);

  }catch(err){
    console.error(err);
  }
}

function render(batches){
  const tbody=document.getElementById("batchTable");
  tbody.innerHTML="";

  let totalShipments=0,delivered=0,pending=0,errors=0;

  batches.forEach(b=>{
    let summary=b.summary||{};
    if(typeof summary==="string"){
      try{summary=JSON.parse(summary)}catch{summary={}}
    }

    totalShipments+=summary.total||0;
    delivered+=summary.delivered||0;
    pending+=summary.pending||0;
    errors+=summary.error||0;

    const percent=summary.total
      ?Math.round((summary.delivered/summary.total)*100)
      :0;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><span style="cursor:pointer;color:var(--primary)" onclick="viewBatch('${b.request_id}')">${b.request_id}</span></td>
      <td><span class="badge ${b.status}">${b.status}</span></td>
      <td>
        <div class="progressBar">
          <div class="progressFill" style="width:${percent}%"></div>
        </div>
        ${percent}%
      </td>
      <td>${b.created_at||"-"}</td>
      <td>${b.status==="completed"
        ?`<button onclick="downloadBatch('${b.request_id}')">Download</button>`
        :"-"}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("totalBatches").innerText=batches.length;
  document.getElementById("totalShipments").innerText=totalShipments;
  document.getElementById("deliveredCount").innerText=delivered;
  document.getElementById("pendingCount").innerText=pending;
  document.getElementById("errorCount").innerText=errors;

  const success=(delivered+pending+errors)
    ?Math.round((delivered/(delivered+pending+errors))*100)
    :0;
  document.getElementById("successRate").innerText=success+"%";

  buildCarrierKpis();
}

async function buildCarrierKpis(){
  const apiKey=document.getElementById("apiKeySelect").value;
  const container=document.getElementById("carrierKpis");
  container.innerHTML="";

  const completed=currentData.filter(b=>b.status==="completed").slice(0,3);

  const carriers={};

  for(const batch of completed){
    const res=await fetch(`${BASE_GET}/track-batch/${batch.request_id}`,{
      headers:{'x-api-key':apiKey}
    });
    const data=await res.json();
    if(!data.results) continue;

    data.results.forEach(r=>{
      const c=r.carrier||"UNKNOWN";
      if(!carriers[c]) carriers[c]={total:0,delivered:0};
      carriers[c].total++;
      if((r.status||"").toLowerCase()==="delivered")
        carriers[c].delivered++;
    });
  }

  Object.entries(carriers).forEach(([name,val])=>{
    const percent=Math.round((val.delivered/val.total)*100);
    const card=document.createElement("div");
    card.className="carrierCard";
    card.innerHTML=`
      <strong>${name}</strong>
      <div>${val.total} shipments</div>
      <div class="miniBar"><div class="miniFill" style="width:${percent}%"></div></div>
      <small>${percent}% delivered</small>
    `;
    container.appendChild(card);
  });
}

async function downloadBatch(id){
  const apiKey=document.getElementById("apiKeySelect").value;
  const res=await fetch(`${BASE_GET}/track-batch/${id}`,{
    headers:{'x-api-key':apiKey}
  });
  const blob=await res.blob();
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=id+".xlsx";
  a.click();
}

async function viewBatch(id){
  const apiKey=document.getElementById("apiKeySelect").value;
  const res=await fetch(`${BASE_GET}/track-batch/${id}`,{
    headers:{'x-api-key':apiKey}
  });
  const data=await res.json();
  if(!data.results) return;

  let html="<h3>Shipment Results</h3><table style='width:100%'><tr><th>Tracking</th><th>Carrier</th><th>Status</th></tr>";
  data.results.forEach(r=>{
    html+=`<tr><td>${r.tracking}</td><td>${r.carrier}</td><td>${r.status}</td></tr>`;
  });
  html+="</table>";

  showModal(html);
}

function showModal(content){
  const overlay=document.createElement("div");
  overlay.className="modalOverlay";
  overlay.innerHTML=`
    <div class="modal">
      <div style="display:flex;justify-content:space-between">
        <strong>Batch Details</strong>
        <button onclick="this.closest('.modalOverlay').remove()">Close</button>
      </div>
      <div style="margin-top:10px">${content}</div>
    </div>
  `;
  document.body.appendChild(overlay);
}

loadDashboard();
setInterval(loadDashboard,15000);
</script>

</body>
</html>
