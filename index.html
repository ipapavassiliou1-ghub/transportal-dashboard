<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TransPortal â€“ API Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: system-ui, -apple-system, sans-serif;
  background:#f4f6fb;
  margin:0;
  padding:30px;
  color:#1f2937;
}

h1 { margin-bottom:8px; }
.subtitle { color:#6b7280; margin-bottom:30px; }

.section {
  background:white;
  padding:20px;
  border-radius:12px;
  margin-bottom:24px;
  box-shadow:0 8px 24px rgba(0,0,0,0.06);
}

label { font-weight:600; display:block; margin-bottom:6px; }

input, select, button {
  padding:10px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:14px;
}

button {
  background:#2563eb;
  color:white;
  border:none;
  cursor:pointer;
}

button:hover { background:#1e40af; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}

th, td {
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  font-size:14px;
}

th { background:#f9fafb; text-align:left; }

.badge {
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}

.completed { background:#dcfce7; color:#166534; }
.processing { background:#fef9c3; color:#92400e; }
.failed { background:#fee2e2; color:#991b1b; }

.small { font-size:12px; color:#6b7280; }

</style>
</head>
<body>

<h1>ðŸ“¦ TransPortal API Dashboard</h1>
<div class="subtitle">Batch tracking management (SaaS Demo)</div>

<!-- API Key Selector -->
<div class="section">
  <label>Select Demo Client</label>
  <select id="apiKeySelect">
    <option value="demo-key-123">Demo Client 1</option>
    <option value="demo-key-456">Demo Client 2</option>
  </select>
</div>

<!-- Upload Batch -->
<div class="section">
  <h3>Upload Batch</h3>

  <label>Tracking File (CSV or XLSX)</label>
  <input type="file" id="fileInput" />

  <label style="margin-top:12px;">Output Format</label>
  <select id="exportFormat">
    <option value="json">JSON</option>
    <option value="csv">CSV</option>
    <option value="xlsx">XLSX</option>
  </select>

  <br><br>
  <button onclick="uploadBatch()">Submit Batch</button>

  <div id="uploadStatus" class="small" style="margin-top:10px;"></div>
</div>

<!-- Batch List -->
<div class="section">
  <h3>Recent Batches</h3>

  <button onclick="loadBatches()">Refresh</button>

  <table>
    <thead>
      <tr>
        <th>Batch ID</th>
        <th>Status</th>
        <th>Created</th>
        <th>Summary</th>
        <th>Result</th>
      </tr>
    </thead>
    <tbody id="batchTable">
      <tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>

const API_BASE = "https://api.transportal.gr/webhook";

function getApiKey() {
  return document.getElementById("apiKeySelect").value;
}

async function uploadBatch() {
  const fileInput = document.getElementById("fileInput");
  const exportFormat = document.getElementById("exportFormat").value;

  if (!fileInput.files.length) {
    alert("Please select a file");
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  formData.append("response_mode", exportFormat === "json" ? "json" : "file");
  formData.append("export_format", exportFormat);

  document.getElementById("uploadStatus").textContent = "Uploading...";

  const res = await fetch(`${API_BASE}/api/v1/track-batch`, {
    method:"POST",
    headers:{ "x-api-key": getApiKey() },
    body:formData
  });

  const data = await res.json();

  document.getElementById("uploadStatus").textContent =
    "Batch created: " + data.request_id;

  loadBatches();
}

async function loadBatches() {
  const tbody = document.getElementById("batchTable");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  const res = await fetch(`${API_BASE}/api/v1/batches`, {
    headers:{ "x-api-key": getApiKey() }
  });

  const data = await res.json();
  const rows = Array.isArray(data) ? data : [];

  tbody.innerHTML = "";

  if (!rows.length) {
    tbody.innerHTML = "<tr><td colspan='5'>No batches yet</td></tr>";
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement("tr");

    const badgeClass =
      r.status === "completed" ? "completed" :
      r.status === "processing" ? "processing" :
      "failed";

    const summary = r.summary
      ? `${r.summary.total ?? 0} shipments`
      : "-";

    const resultBtn =
      r.status === "completed"
        ? `<button onclick="viewBatch('${r.request_id}', '${r.result_format}')">Open</button>`
        : "-";

    tr.innerHTML = `
      <td>${r.request_id}</td>
      <td><span class="badge ${badgeClass}">${r.status}</span></td>
      <td>${r.created_at ?? "-"}</td>
      <td>${summary}</td>
      <td>${resultBtn}</td>
    `;

    tbody.appendChild(tr);
  });
}

async function viewBatch(batchId, format) {
  const res = await fetch(`${API_BASE}/api/v1/track-batch/${batchId}`, {
    headers:{ "x-api-key": getApiKey() }
  });

  if (format === "json") {
    const data = await res.json();
    alert(JSON.stringify(data, null, 2));
  } else {
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    window.open(url);
  }
}

loadBatches();

</script>

</body>
</html>
